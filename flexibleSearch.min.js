/*
 * flexibleSearch.js
 *
 * Copyright (c) Tomohiro Okuwaki / bit part LLC (http://bit-part.net/)
 *
 * Since  : 2010-11-12
 * Update : 2019-11-05
 * Version: 2.4.0
 * Comment: Please use this with Movable Type :)
 *
 * You have to include "mustache.js" before "flexibleSearch.js".
 * Maybe... jQuery 1.7.x later
 *
-*/
!function(e){e.fn.flexibleSearch=function(a){function t(e,a,t,n,r){var l=0;if("like"===n){for(var s in a){for(var i=a[s].split(","),o=i.length,c=0,u=-1,d=o;++u<d;){var m=new RegExp(i[u].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");if("undefined"==typeof e[s]||"string"==typeof e[s]&&m.test(e[s])){if("AND"!==r&&"and"!==r){l++;break}c++}}("AND"===r||"and"===r)&&c===o&&l++}return l===t}for(var s in a)if(e[s]&&"string"==typeof e[s]&&e[s]!==a[s])return!1;return l}function n(e,a){for(var t=a.length,n=0,r=-1;++r<t;){var l=new RegExp(a[r].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");for(var s in e)if(l.test(e[s])){n++;break}}return t===n}function r(e,a,t,n){(a||"string"==typeof a)&&(t="ascend"===t?-1:1,e.sort(function(e,r){var l=e[a],s=r[a];return"numeric"===n?(l-=0,s-=0):"string"===n&&(l=""+l,s=""+s),s>l?1*t:l>s?-1*t:0}))}var l=e.extend({},e.fn.flexibleSearch.defaults,a),s=this;if(l.searchFormCreation){var i=[],o="";if(null!==l.advancedFormObj&&("hidden"in l.advancedFormObj&&i.push(['<div class="fs-advanced-hidden" style="display:none;">',"{{#hidden}}",'<input type="hidden"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}>',"{{/hidden}}","</div>"].join("")),"text"in l.advancedFormObj&&i.push(['<div class="fs-advanced-text">',"{{#text}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-text{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="text"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#placeholder}} placeholder="{{placeholder}}"{{/placeholder}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/text}}","</div>"].join("")),"checkbox"in l.advancedFormObj&&i.push(['<div class="fs-advanced-checkbox">',"{{#checkbox}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-checkbox{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="checkbox"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/checkbox}}","</div>"].join("")),"radio"in l.advancedFormObj&&i.push(['<div class="fs-advanced-radio">',"{{#radio}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-radio{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="radio"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/radio}}","</div>"].join("")),o=Mustache.render(i.join(""),l.advancedFormObj),"select"in l.advancedFormObj)){var c={selects:l.advancedFormObj.select,options:function(){for(var e=this.option,a=[],t=0,n=e.length;n>t;t++){var r=e[t].selected?" selected":"";a.push('<option value="'+e[t].value+'"'+r+">"+e[t].label+"</option>")}return a.join("")}},u=['<div class="fs-advanced-select">',"{{#selects}}",'<select{{#id}} id="{{id}}"{{/id}}{{#name}} name="{{name}}"{{/name}}{{#size}} size="{{size}}"{{/size}}{{#multiple}} multiple{{/multiple}} class="fs-select{{#name}} fs-{{name}}{{/name}}">',"{{{options}}}","</select>","{{/selects}}","</div>"].join("");o+=Mustache.render(u,c)}var d={action:l.searchFormAction,type:l.searchFormInputType,placeholder:l.searchFormInputPlaceholder,submitBtnText:l.searchFormSubmitBtnText},m="";if(null!==l.limit&&"number"==typeof l.limit&&(l.paginateCount=l.limit),null!==l.searchFormHTML)m=l.searchFormHTML;else{var p=['<form action="{{action}}" method="GET">','<input type="hidden" name="offset" value="0">','<input type="hidden" name="limit" value="'+l.paginateCount+'">','<input type="{{type}}" name="search" placeholder="{{placeholder}}" class="fs-text fs-search">','<input type="submit" value="{{submitBtnText}}" class="fs-btn fs-submit">',o,"</form>"].join("");m=Mustache.render(p,d)}s[0].innerHTML=m}var h="";null!==l.loadingImgHTML?h=l.loadingImgHTML:l.loadingImgPath&&(h='<span class="fs-loading"><img src="'+l.loadingImgPath+'" alt=""></span>');var f="";f=null!==l.resultMsgTmpl?l.resultMsgTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<p>","{{#keywords}}「{{keywords}}」が {{/keywords}}","{{#count}}{{count}} 件見つかりました。{{/count}}","{{^count}}見つかりませんでした。{{/count}}","{{#count}}（{{lastPage}} ページ中 {{currentPage}} ページ目を表示）{{/count}}","</p>","</div>"].join("");var g="";g=null!==l.resultItemTmpl?l.resultItemTmpl:['<div id="'+l.resultBlockId+'-items">',"<ul>","{{#items}}","<li>{{&title}}</li>","{{/items}}","</ul>","</div>"].join("");var v="";v=null!==l.paginateTmpl?l.paginateTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<ul>","{{#showTurnPage}}","{{#exceptFirst}}",'<li class="fs-prev"><span><a class="fs-prev-link fs-turn-page-link" href="#" title="{{prevPageText}}">{{prevPageText}}</a></span></li>',"{{/exceptFirst}}","{{/showTurnPage}}","{{#page}}","{{#checkRange}}",'<li class="{{current}}"{{#hidePageNumber}} style="display:none;"{{/hidePageNumber}}><span><a class="fs-page-link {{currentLink}}" href="#" title="{{pageNumber}}">{{pageNumber}}</a></span></li>',"{{/checkRange}}","{{/page}}","{{#showTurnPage}}","{{#exceptLast}}",'<li class="fs-next"><span><a class="fs-next-link fs-turn-page-link" href="#" title="{{nextPageText}}">{{nextPageText}}</a></span></li>',"{{/exceptLast}}","{{/showTurnPage}}","</ul>","</div>"].join(""),s.find("form").on("submit",function(a){a.preventDefault();for(var t=e(this).attr("action")||location.href.replace(/\?.*/,""),n=e(this).serializeArray(),r=-1,s=n.length;++r<s;)"search"===n[r].name&&(n[r].value=e.trim(n[r].value.replace(/[ |　]+/g," ")));n=l.submitAction(n);var i=e.param(n);return i&&(t=t+"?"+i),location.href=t,!1});var b=decodeURIComponent(location.search.replace(/^\?/,""));if(""===b&&null!==l.initialParameter&&"string"==typeof l.initialParameter&&(b=decodeURIComponent(l.initialParameter.replace(/^\?/,""))),""===b){switch(typeof l.searchDataPathPreload){case"string":e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload});break;case"object":if(null===l.searchDataPathPreload||""===l.searchDataPathPreload)break;if(l.searchDataPathPreload.length)for(var P=-1,y=l.searchDataPathPreload.length;++P<y;)e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload[P]});else for(var T in l.searchDataPathPreload)e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload[T]})}return!1}h&&(document.getElementById(l.resultBlockId).innerHTML=h);var x=[],M=b.split(/&|%26/),k={},I=[],j={},N=null!==l.limit&&"number"==typeof l.limit?l.limit:10,w=0,C="",L="",R="",F="",D="",S=!1,H=["search","dataId","offset","limit","sortBy","sortOrder","sortType"];l.simplePaginate===!0&&H.push("page"),null!==l.excludeParams&&e.merge(H,l.excludeParams.toLowerCase().split(","));for(var P=-1,y=M.length;++P<y;){var O=M[P].split("="),T=O[0],A=O[1]||"";switch(k[T]=A,T){case"search":A="+"===A?"":A,x=A.split(/\+| |%20/);break;case"offset":w=A;break;case"limit":N=null!==l.limit&&"number"==typeof l.limit?l.limit:A;break;case"dataId":D=A;break;case"sortBy":C=A.toLowerCase();break;case"sortOrder":L=A.toLowerCase();break;case"sortType":R=A.toLowerCase()}if("offset"!==T&&"limit"!==T&&(l.simplePaginate!==!0||"page"!==T)){if(s.find("[name='"+T+"']").each(function(){var a=this.tagName.toLowerCase();switch(a){case"input":var t=e(this).attr("type");"checkbox"===t&&e(this).val()===A?e(this).prop("checked",!0):"radio"===t&&e(this).val()===A?e(this).prop("checked",!0):("text"===t||"search"===t||"hidden"===t)&&e(this).val("search"===T?A.replace(/\+/g," "):A);break;case"select":e(this).find("option").each(function(){e(this).val()===A?e(this).prop("selected",!0):""===A&&" "===e(this).val()&&e(this).prop("selected",!0)})}}),""!==A){if(A=A.replace(/\+/g," "),-1!==e.inArray(T,H))continue;-1!==e.inArray(T,I)?j[T]+=","+A:j[T]=A}I.push(T)}}l.simplePaginate===!0&&"undefined"!=typeof k.page&&(/all/i.test(k.page)?(w=0,N=1e8):w=(k.page-1)*N);var B=0;for(var T in j)B++;switch(typeof l.searchDataPath){case"string":F=l.searchDataPath;break;case"object":if(""===D)return void window.alert("dataId is required.");null!==l.dataApiDataIds&&-1!==e.inArray(D,l.dataApiDataIds.split(","))&&(S=!0,null!==l.dataApiParams&&(b+=""!==b?"&"+e.param(l.dataApiParams):e.param(l.dataApiParams))),F=l.searchDataPath[D]}S&&(F+="?"+b),e.ajax({type:"GET",cache:l.cache,dataType:"json",url:F,error:function(e,a,t){l.ajaxError(e,a,t)},success:function(a){var s={};if(S)s=a;else{var i=e.grep(a.items,function(){return!0});i=e.grep(i,function(e,a){return t(e,j,B,"like",l.advancedSearchCond)}),i=e.grep(i,function(e,a){return n(e,x)}),null!==l.customSearch&&"function"==typeof l.customSearch&&(i=e.grep(i,function(e,a){return l.customSearch(e,k)}));var o=Number(N)+Number(w);s.totalResults=i.length,0!==s.totalResults&&""!==C&&C in i[0]&&("ascend"!==L&&(L="descend"),"numeric"!==R&&(R="string"),r(i,C,L,R)),null!==l.customSort&&"function"==typeof l.customSort&&(i=l.customSort(i,k)),s.items=e.grep(i,function(e,a){return w>a?!1:a>=o?!1:!0})}var c,u,d=Math.ceil(w/N)+1,m=Math.ceil(s.totalResults/N),p=l.maxPageCount?l.maxPageCount:100,h=p%2==0?p/2-1:Math.floor(p/2),b=p%2==0?p/2:Math.floor(p/2);p>=m?(c=1,u=m):(c=d-h,u=d+b,1>c?(c=1,u=p):u>m&&(b=m-d,u=m,h=p-b,c=d-h));for(var P=[],y=0,T=m;++y<=T;)P.push({pageNumber:y});var M={id:l.paginateId,classname:l.paginateClassName,page:P,hidePageNumber:l.hidePageNumber,showTurnPage:l.showTurnPage,prevPageText:l.prevPageText,nextPageText:l.nextPageText,isFirst:function(){return 1===d},isLast:function(){return P.length?d===P.length:!0},exceptFirst:function(){return 1!==d},exceptLast:function(){return P.length>0&&d!==P.length},checkRange:function(){return this.pageNumber>=c&&this.pageNumber<=u},current:function(){return this.pageNumber===d?"fs-current":this.pageNumber===d-1?"fs-current-prev":this.pageNumber===d+1?"fs-current-next":""},isCurrent:function(){return this.pageNumber===d},lastPage:function(){return M.page.length},currentLink:function(){return this.pageNumber===d?"fs-current-link":this.pageNumber===d-1?"fs-current-prev-link":this.pageNumber===d+1?"fs-current-next-link":""},currentCountFrom:function(){return w-0+1},currentCountTo:function(){var e=w-0+N,a=e<s.totalResults?e:s.totalResults;return a-0},totalResults:s.totalResults,count:s.totalResults,currentPage:d},I=Mustache.render(v,M),F={id:l.resultMsgId?l.resultMsgId:"",classname:l.resultMsgClassName?l.resultMsgClassName:"",keywords:x.join(", "),keywordArray:""!==x.join("")?x:null,count:s.totalResults,metaTitle:document.title,firstPage:function(){return M.page[0].pageNumber},lastPage:function(){return M.page.length},currentPage:d,param:k},D=Mustache.render(f,F);if(l.resultMetaTitleRewrite){var H=l.resultMetaTitleTmpl?l.resultMetaTitleTmpl:["{{#keywordArray}}{{.}} {{/keywordArray}}","{{#count}} {{count}}件{{/count}}","{{#count}} {{currentPage}}/{{lastPage}}{{/count}}","{{#metaTitle}} | {{metaTitle}}{{/metaTitle}}"].join(""),O=Mustache.render(H,F);document.title=O}null!==l.modifyResultJSON&&"function"==typeof l.modifyResultJSON&&(s=l.modifyResultJSON(s));var A=Mustache.render(g,s);null!==l.modifyResultMsgHTML&&"function"==typeof l.modifyResultMsgHTML&&(D=l.modifyResultMsgHTML(D)),null!==l.modifyResultItemHTML&&"function"==typeof l.modifyResultItemHTML&&(A=l.modifyResultItemHTML(A)),null!==l.modifyPaginateHTML&&"function"==typeof l.modifyPaginateHTML&&(I=l.modifyPaginateHTML(I));var E="";if(null===l.resultMsgInsertMethods&&(E+=D),E+=A,1===m&&l.hideOnePagePaginate===!0||null===l.paginateInsertMethods&&(E+=I),document.getElementById(l.resultBlockId).innerHTML=E,null!==l.resultMsgInsertMethods)for(var y=0,z=l.resultMsgInsertMethods.length;z>y;y++)e(l.resultMsgInsertMethods[y].selector)[l.resultMsgInsertMethods[y].method](D);if(1===m&&l.hideOnePagePaginate===!0);else if(null!==l.paginateInsertMethods)for(var y=0,z=l.paginateInsertMethods.length;z>y;y++)e(l.paginateInsertMethods[y].selector)[l.paginateInsertMethods[y].method](I);null!==l.resultComplete&&"function"==typeof l.resultComplete&&l.resultComplete(s.totalResults);var G=l.paginateId?"#"+l.paginateId:"."+l.paginateClassName;e(G+" a.fs-page-link").on("click",function(a){a.preventDefault();var t=e(this).attr("title"),n=(Number(t)-1)*Number(N),r=location.href.replace(/\?.*/g,""),s=location.search?location.search.replace(/^\?/,""):l.initialParameter;l.simplePaginate===!0?(-1===s.indexOf("page=")?s+=s?"&page="+t:"page="+t:s=s.replace(/page=[0-9]+/,"page="+t),s=s.replace(/&?offset=[0-9]+/g,"")):(-1===s.indexOf("offset=")?s+=s?"&offset="+n:"offset="+n:s=s.replace(/offset=[0-9]+/,"offset="+n),s=s.replace(/&?offset=0/,"")),s&&(r+="?"+s.replace(/^&+/,"")),location.href=r}),e(G+" a.fs-turn-page-link").on("click",function(a){a.preventDefault(),e(this).hasClass("fs-prev-link")?e(G).find(".fs-current-prev-link").trigger("click"):e(this).hasClass("fs-next-link")&&e(G).find(".fs-current-next-link").trigger("click")})}})},e.fn.flexibleSearch.defaults={initialParameter:null,limit:null,simplePaginate:!1,searchDataPath:"/flexibleSearch/search.json",searchDataPathPreload:null,dataApiDataIds:null,dataApiParams:null,cache:!0,searchFormCreation:!0,searchFormHTML:null,searchFormAction:"",searchFormInputType:"search",searchFormInputPlaceholder:"Search words",searchFormSubmitBtnText:"Search",advancedFormObj:null,advancedSearchCond:"OR",loadingImgPath:"/flexibleSearch/loading.gif",loadingImgHTML:null,resultBlockId:"fs-result",resultItemTmpl:null,resultMsgId:null,resultMsgClassName:"fs-result-msg",resultMsgTmpl:null,resultMetaTitleRewrite:!0,resultMetaTitleTmpl:null,resultMsgInsertMethods:null,paginateId:null,paginateClassName:"fs-paginate",paginateTmpl:null,paginateCount:10,hidePageNumber:!1,showTurnPage:!0,prevPageText:"Prev",nextPageText:"Next",maxPageCount:10,hideOnePagePaginate:!1,paginateInsertMethods:null,submitAction:function(e){return e},ajaxError:function(e,a,t){window.alert(a)},customSearch:null,modifyResultJSON:null,modifyResultMsgHTML:null,modifyResultItemHTML:null,modifyPaginateHTML:null,resultComplete:null,excludeParams:null,dummy:!1}}(jQuery);
