/**!
 * flexibleSearch.js
 *
 * Copyright (c) Tomohiro Okuwaki / bit part LLC (http://bit-part.net/)
 *
 * Since  : 2010-11-12
 * Update : 2020-02-12
 * Version: 2.5.0
 * Comment: Please use this with Movable Type :)
 *
 * You have to include "mustache.js" before "flexibleSearch.js".
 * Maybe... jQuery 1.7.x later
 */
!function(e){e.fn.flexibleSearch=function(a){var t=e.extend({},e.fn.flexibleSearch.defaults,a);if(t.searchFormCreation){var n=[],r="";if(null!==t.advancedFormObj&&("hidden"in t.advancedFormObj&&n.push(['<div class="fs-advanced-hidden" style="display:none;">',"{{#hidden}}",'<input type="hidden"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}>',"{{/hidden}}","</div>"].join("")),"text"in t.advancedFormObj&&n.push(['<div class="fs-advanced-text">',"{{#text}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-text{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="text"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#placeholder}} placeholder="{{placeholder}}"{{/placeholder}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/text}}","</div>"].join("")),"checkbox"in t.advancedFormObj&&n.push(['<div class="fs-advanced-checkbox">',"{{#checkbox}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-checkbox{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="checkbox"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/checkbox}}","</div>"].join("")),"radio"in t.advancedFormObj&&n.push(['<div class="fs-advanced-radio">',"{{#radio}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-radio{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="radio"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/radio}}","</div>"].join("")),r=Mustache.render(n.join(""),t.advancedFormObj),"select"in t.advancedFormObj)){var l={selects:t.advancedFormObj.select,options:function(){for(var e=this.option,a=[],t=0,n=e.length;t<n;t++){var r=e[t].selected?" selected":"";a.push('<option value="'+e[t].value+'"'+r+">"+e[t].label+"</option>")}return a.join("")}},s=['<div class="fs-advanced-select">',"{{#selects}}",'<select{{#id}} id="{{id}}"{{/id}}{{#name}} name="{{name}}"{{/name}}{{#size}} size="{{size}}"{{/size}}{{#multiple}} multiple{{/multiple}} class="fs-select{{#name}} fs-{{name}}{{/name}}">',"{{{options}}}","</select>","{{/selects}}","</div>"].join("");r+=Mustache.render(s,l)}var i={action:t.searchFormAction,type:t.searchFormInputType,placeholder:t.searchFormInputPlaceholder,submitBtnText:t.searchFormSubmitBtnText},o="";if(null!==t.limit&&"number"==typeof t.limit&&(t.paginateCount=t.limit),null!==t.searchFormHTML)o=t.searchFormHTML;else{var c=['<form action="{{action}}" method="GET">','<input type="hidden" name="offset" value="0">','<input type="hidden" name="limit" value="'+t.paginateCount+'">','<input type="{{type}}" name="search" placeholder="{{placeholder}}" class="fs-text fs-search">','<input type="submit" value="{{submitBtnText}}" class="fs-btn fs-submit">',r,"</form>"].join("");o=Mustache.render(c,i)}this[0].innerHTML=o}var u="";null!==t.loadingImgHTML?u=t.loadingImgHTML:t.loadingImgPath&&(u='<span class="fs-loading"><img src="'+t.loadingImgPath+'" alt=""></span>');var d="";d=null!==t.resultMsgTmpl?t.resultMsgTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<p>","{{#keywords}}「{{keywords}}」が {{/keywords}}","{{#count}}{{count}} 件見つかりました。{{/count}}","{{^count}}見つかりませんでした。{{/count}}","{{#count}}（{{lastPage}} ページ中 {{currentPage}} ページ目を表示）{{/count}}","</p>","</div>"].join("");var m="";m=null!==t.resultItemTmpl?t.resultItemTmpl:['<div id="'+t.resultBlockId+'-items">',"<ul>","{{#items}}","<li>{{&title}}</li>","{{/items}}","</ul>","</div>"].join("");var p="";p=null!==t.paginateTmpl?t.paginateTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<ul>","{{#showTurnPage}}","{{#exceptFirst}}",'<li class="fs-prev"><span><a class="fs-prev-link fs-turn-page-link" href="#" title="{{prevPageText}}">{{prevPageText}}</a></span></li>',"{{/exceptFirst}}","{{/showTurnPage}}","{{#page}}","{{#checkRange}}",'<li class="{{current}}"{{#hidePageNumber}} style="display:none;"{{/hidePageNumber}}><span><a class="fs-page-link {{currentLink}}" href="#" title="{{pageNumber}}">{{pageNumber}}</a></span></li>',"{{/checkRange}}","{{/page}}","{{#showTurnPage}}","{{#exceptLast}}",'<li class="fs-next"><span><a class="fs-next-link fs-turn-page-link" href="#" title="{{nextPageText}}">{{nextPageText}}</a></span></li>',"{{/exceptLast}}","{{/showTurnPage}}","</ul>","</div>"].join(""),this.find("form").on("submit",(function(a){a.preventDefault();for(var n=e(this).attr("action")||location.href.replace(/\?.*/,""),r=e(this).serializeArray(),l=-1,s=r.length;++l<s;)"search"===r[l].name&&(r[l].value=e.trim(r[l].value.replace(/[ |　]+/g," ")));r=t.submitAction(r);var i=e.param(r);return i&&(n=n+"?"+i),location.href=n,!1}));var h=decodeURIComponent(location.search.replace(/^\?/,""));if(""===h&&null!==t.initialParameter&&"string"==typeof t.initialParameter&&(h=decodeURIComponent(t.initialParameter.replace(/^\?/,""))),""===h){switch(typeof t.searchDataPathPreload){case"string":e.ajax({type:"GET",cache:!0,dataType:"json",url:t.searchDataPathPreload});break;case"object":if(null===t.searchDataPathPreload||""===t.searchDataPathPreload)break;if(t.searchDataPathPreload.length)for(var f=-1,g=t.searchDataPathPreload.length;++f<g;)e.ajax({type:"GET",cache:!0,dataType:"json",url:t.searchDataPathPreload[f]});else for(var v in t.searchDataPathPreload)e.ajax({type:"GET",cache:!0,dataType:"json",url:t.searchDataPathPreload[v]})}return!1}u&&(document.getElementById(t.resultBlockId).innerHTML=u);var b=[],P=h.split(/&|%26/),y={},T=[],x={},M=null!==t.limit&&"number"==typeof t.limit?t.limit:10,k=0,I="",j="",N="",w="",C="",L=!1,R=["search","dataId","offset","limit","sortBy","sortOrder","sortType"],F=t.excludeSearchParams?t.excludeSearchParams.split(","):[];!0===t.simplePaginate&&R.push("page"),null!==t.excludeParams&&e.merge(R,t.excludeParams.toLowerCase().split(","));for(f=-1,g=P.length;++f<g;){var S=P[f].split("="),D=(v=S[0],S[1]||"");switch(y[v]=D,v){case"search":b=(D="+"===D?"":D).split(/\+| |%20/);break;case"offset":k=D;break;case"limit":M=null!==t.limit&&"number"==typeof t.limit?t.limit:D;break;case"dataId":C=D;break;case"sortBy":I=D.toLowerCase();break;case"sortOrder":j=D.toLowerCase();break;case"sortType":N=D.toLowerCase()}if("offset"!==v&&"limit"!==v&&(!0!==t.simplePaginate||"page"!==v)){if(this.find("[name='"+v+"']").each((function(){switch(this.tagName.toLowerCase()){case"input":var a=e(this).attr("type");"checkbox"===a&&e(this).val()===D?e(this).prop("checked",!0):"radio"===a&&e(this).val()===D?e(this).prop("checked",!0):"text"!==a&&"search"!==a&&"hidden"!==a||("search"===v?e(this).val(D.replace(/\+/g," ")):e(this).val(D));break;case"select":e(this).find("option").each((function(){e(this).val()===D?e(this).prop("selected",!0):""===D&&" "===e(this).val()&&e(this).prop("selected",!0)}))}})),""!==D){if(D=D.replace(/\+/g," "),-1!==e.inArray(v,R))continue;-1!==e.inArray(v,T)?x[v]+=","+D:x[v]=D}T.push(v)}}!0===t.simplePaginate&&void 0!==y.page&&(/all/i.test(y.page)?(k=0,M=1e8):k=(y.page-1)*M);var A=0;for(var v in x)A++;switch(typeof t.searchDataPath){case"string":w=t.searchDataPath;break;case"object":if(""===C)return void window.alert("dataId is required.");null!==t.dataApiDataIds&&-1!==e.inArray(C,t.dataApiDataIds.split(","))&&(L=!0,null!==t.dataApiParams&&(h+=""!==h?"&"+e.param(t.dataApiParams):e.param(t.dataApiParams))),w=t.searchDataPath[C]}L&&(w+="?"+h),e.ajax({type:"GET",cache:t.cache,dataType:"json",url:w,error:function(e,a,n){t.ajaxError(e,a,n)},success:function(a){var n={};if(L)n=a;else{var r=e.grep(a.items,(function(){return!0}));r=e.grep(r,(function(e,a){return function(e,a,t,n,r){var l=0;if("like"===n){for(var s in a){for(var i=a[s].split(","),o=i.length,c=0,u=-1,d=o;++u<d;){var m=new RegExp(i[u].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");if(void 0===e[s]||"string"==typeof e[s]&&m.test(e[s])){if("AND"!==r&&"and"!==r){l++;break}c++}}"AND"!==r&&"and"!==r||c===o&&l++}return l===t}for(var s in a)if(e[s]&&"string"==typeof e[s]&&e[s]!==a[s])return!1;return l}(e,x,A,"like",t.advancedSearchCond)})),r=e.grep(r,(function(a,t){return function(a,t){for(var n=t.length,r=0,l=-1;++l<n;){var s=new RegExp(t[l].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");for(var i in a)if(-1===e.inArray(i,F)&&s.test(a[i])){r++;break}}return n===r}(a,b)})),null!==t.customSearch&&"function"==typeof t.customSearch&&(r=e.grep(r,(function(e,a){return t.customSearch(e,y)})));var l=Number(M)+Number(k);n.totalResults=r.length,0!==n.totalResults&&""!==I&&I in r[0]&&("ascend"!==j&&(j="descend"),"numeric"!==N&&(N="string"),function(e,a,t,n){if(!a&&"string"!=typeof a)return;t="ascend"===t?-1:1,e.sort((function(e,r){var l=e[a],s=r[a];return"numeric"===n?(l-=0,s-=0):"string"===n&&(l=""+l,s=""+s),l<s?1*t:l>s?-1*t:0}))}(r,I,j,N)),null!==t.customSort&&"function"==typeof t.customSort&&(r=t.customSort(r,y)),n.items=e.grep(r,(function(e,a){return!(a<k)&&!(a>=l)}))}var s,i,o=Math.ceil(k/M)+1,c=Math.ceil(n.totalResults/M),u=t.maxPageCount?t.maxPageCount:100,h=u%2==0?u/2-1:Math.floor(u/2),f=u%2==0?u/2:Math.floor(u/2);c<=u?(s=1,i=c):(i=o+f,(s=o-h)<1?(s=1,i=u):i>c&&(i=c,s=o-(h=u-(f=c-o))));for(var g=[],v=0,P=c;++v<=P;)g.push({pageNumber:v});var T={id:t.paginateId,classname:t.paginateClassName,page:g,hidePageNumber:t.hidePageNumber,showTurnPage:t.showTurnPage,prevPageText:t.prevPageText,nextPageText:t.nextPageText,isFirst:function(){return 1===o},isLast:function(){return!g.length||o===g.length},exceptFirst:function(){return 1!==o},exceptLast:function(){return g.length>0&&o!==g.length},checkRange:function(){return this.pageNumber>=s&&this.pageNumber<=i},current:function(){return this.pageNumber===o?"fs-current":this.pageNumber===o-1?"fs-current-prev":this.pageNumber===o+1?"fs-current-next":""},isCurrent:function(){return this.pageNumber===o},lastPage:function(){return T.page.length},currentLink:function(){return this.pageNumber===o?"fs-current-link":this.pageNumber===o-1?"fs-current-prev-link":this.pageNumber===o+1?"fs-current-next-link":""},currentCountFrom:function(){return k-0+1},currentCountTo:function(){var e=k-0+M;return(e<n.totalResults?e:n.totalResults)-0},totalResults:n.totalResults,count:n.totalResults,currentPage:o},w=Mustache.render(p,T),C={id:t.resultMsgId?t.resultMsgId:"",classname:t.resultMsgClassName?t.resultMsgClassName:"",keywords:b.join(", "),keywordArray:""!==b.join("")?b:null,count:n.totalResults,metaTitle:document.title,firstPage:function(){return T.page[0].pageNumber},lastPage:function(){return T.page.length},currentPage:o,param:y},R=Mustache.render(d,C);if(t.resultMetaTitleRewrite){var S=t.resultMetaTitleTmpl?t.resultMetaTitleTmpl:["{{#keywordArray}}{{.}} {{/keywordArray}}","{{#count}} {{count}}件{{/count}}","{{#count}} {{currentPage}}/{{lastPage}}{{/count}}","{{#metaTitle}} | {{metaTitle}}{{/metaTitle}}"].join(""),D=Mustache.render(S,C);document.title=D}null!==t.modifyResultJSON&&"function"==typeof t.modifyResultJSON&&(n=t.modifyResultJSON(n));var H=Mustache.render(m,n);null!==t.modifyResultMsgHTML&&"function"==typeof t.modifyResultMsgHTML&&(R=t.modifyResultMsgHTML(R)),null!==t.modifyResultItemHTML&&"function"==typeof t.modifyResultItemHTML&&(H=t.modifyResultItemHTML(H)),null!==t.modifyPaginateHTML&&"function"==typeof t.modifyPaginateHTML&&(w=t.modifyPaginateHTML(w));var O="";if(null===t.resultMsgInsertMethods&&(O+=R),O+=H,1===c&&!0===t.hideOnePagePaginate||null===t.paginateInsertMethods&&(O+=w),document.getElementById(t.resultBlockId).innerHTML=O,null!==t.resultMsgInsertMethods){v=0;for(var B=t.resultMsgInsertMethods.length;v<B;v++)e(t.resultMsgInsertMethods[v].selector)[t.resultMsgInsertMethods[v].method](R)}if(1===c&&!0===t.hideOnePagePaginate);else if(null!==t.paginateInsertMethods)for(v=0,B=t.paginateInsertMethods.length;v<B;v++)e(t.paginateInsertMethods[v].selector)[t.paginateInsertMethods[v].method](w);null!==t.resultComplete&&"function"==typeof t.resultComplete&&t.resultComplete(n.totalResults);var E=t.paginateId?"#"+t.paginateId:"."+t.paginateClassName;e(E+" a.fs-page-link").on("click",(function(a){a.preventDefault();var n=e(this).attr("title"),r=(Number(n)-1)*Number(M),l=location.href.replace(/\?.*/g,""),s=location.search?location.search.replace(/^\?/,""):t.initialParameter;!0===t.simplePaginate?(-1===s.indexOf("page=")?s+=s?"&page="+n:"page="+n:s=s.replace(/page=[0-9]+/,"page="+n),s=s.replace(/&?offset=[0-9]+/g,"")):(-1===s.indexOf("offset=")?s+=s?"&offset="+r:"offset="+r:s=s.replace(/offset=[0-9]+/,"offset="+r),s=s.replace(/&?offset=0/,"")),s&&(l+="?"+s.replace(/^&+/,"")),location.href=l})),e(E+" a.fs-turn-page-link").on("click",(function(a){a.preventDefault(),e(this).hasClass("fs-prev-link")?e(E).find(".fs-current-prev-link").trigger("click"):e(this).hasClass("fs-next-link")&&e(E).find(".fs-current-next-link").trigger("click")}))}})},e.fn.flexibleSearch.defaults={initialParameter:null,limit:null,simplePaginate:!1,searchDataPath:"/flexibleSearch/search.json",searchDataPathPreload:null,dataApiDataIds:null,dataApiParams:null,cache:!0,searchFormCreation:!0,searchFormHTML:null,searchFormAction:"",searchFormInputType:"search",searchFormInputPlaceholder:"Search words",searchFormSubmitBtnText:"Search",advancedFormObj:null,advancedSearchCond:"OR",loadingImgPath:"/flexibleSearch/loading.gif",loadingImgHTML:null,resultBlockId:"fs-result",resultItemTmpl:null,resultMsgId:null,resultMsgClassName:"fs-result-msg",resultMsgTmpl:null,resultMetaTitleRewrite:!0,resultMetaTitleTmpl:null,resultMsgInsertMethods:null,paginateId:null,paginateClassName:"fs-paginate",paginateTmpl:null,paginateCount:10,hidePageNumber:!1,showTurnPage:!0,prevPageText:"Prev",nextPageText:"Next",maxPageCount:10,hideOnePagePaginate:!1,paginateInsertMethods:null,submitAction:function(e){return e},ajaxError:function(e,a,t){window.alert(a)},customSearch:null,modifyResultJSON:null,modifyResultMsgHTML:null,modifyResultItemHTML:null,modifyPaginateHTML:null,resultComplete:null,excludeParams:null,excludeSearchParams:null,dummy:!1}}(jQuery);