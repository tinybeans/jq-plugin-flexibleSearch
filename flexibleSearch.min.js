!function(e){e.fn.flexibleSearch=function(a){function t(e,a,t,n,r){var l=0;if("like"===n){for(var s in a){for(var i=a[s].split(","),c=i.length,o=0,u=-1,d=c;++u<d;){var m=new RegExp(i[u].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");if("undefined"==typeof e[s]||"string"==typeof e[s]&&m.test(e[s])){if("AND"!==r&&"and"!==r){l++;break}o++}}("AND"===r||"and"===r)&&o===c&&l++}return l===t}for(var s in a)if(e[s]&&"string"==typeof e[s]&&e[s]!==a[s])return!1;return l}function n(e,a){for(var t=a.length,n=0,r=-1;++r<t;){var l=new RegExp(a[r].replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"i");for(var s in e)if(l.test(e[s])){n++;break}}return t===n}function r(e,a,t,n){(a||"string"==typeof a)&&(t="ascend"===t?-1:1,e.sort(function(e,r){var l=e[a],s=r[a];return"numeric"===n?(l-=0,s-=0):"string"===n&&(l=""+l,s=""+s),s>l?1*t:l>s?-1*t:0}))}var l=e.extend({},e.fn.flexibleSearch.defaults,a),s=this;if(l.searchFormCreation){var i=[],c="";if(null!==l.advancedFormObj&&("hidden"in l.advancedFormObj&&i.push(['<div class="fs-advanced-hidden" style="display:none;">',"{{#hidden}}",'<input type="hidden"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}>',"{{/hidden}}","</div>"].join("")),"text"in l.advancedFormObj&&i.push(['<div class="fs-advanced-text">',"{{#text}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-text{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="text"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#placeholder}} placeholder="{{placeholder}}"{{/placeholder}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/text}}","</div>"].join("")),"checkbox"in l.advancedFormObj&&i.push(['<div class="fs-advanced-checkbox">',"{{#checkbox}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-checkbox{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="checkbox"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/checkbox}}","</div>"].join("")),"radio"in l.advancedFormObj&&i.push(['<div class="fs-advanced-radio">',"{{#radio}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-radio{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="radio"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/radio}}","</div>"].join("")),c=Mustache.render(i.join(""),l.advancedFormObj),"select"in l.advancedFormObj)){var o={selects:l.advancedFormObj.select,options:function(){for(var e=this.option,a=[],t=0,n=e.length;n>t;t++){var r=e[t].selected?" selected":"";a.push('<option value="'+e[t].value+'"'+r+">"+e[t].label+"</option>")}return a.join("")}},u=['<div class="fs-advanced-select">',"{{#selects}}",'<select{{#id}} id="{{id}}"{{/id}}{{#name}} name="{{name}}"{{/name}}{{#size}} size="{{size}}"{{/size}}{{#multiple}} multiple{{/multiple}} class="fs-select{{#name}} fs-{{name}}{{/name}}">',"{{{options}}}","</select>","{{/selects}}","</div>"].join("");c+=Mustache.render(u,o)}var d={action:l.searchFormAction,type:l.searchFormInputType,placeholder:l.searchFormInputPlaceholder,submitBtnText:l.searchFormSubmitBtnText},m="";if(null!==l.limit&&"number"==typeof l.limit&&(l.paginateCount=l.limit),null!==l.searchFormHTML)m=l.searchFormHTML;else{var h=['<form action="{{action}}" method="GET">','<input type="hidden" name="offset" value="0">','<input type="hidden" name="limit" value="'+l.paginateCount+'">','<input type="{{type}}" name="search" placeholder="{{placeholder}}" class="fs-text fs-search">','<input type="submit" value="{{submitBtnText}}" class="fs-btn fs-submit">',c,"</form>"].join("");m=Mustache.render(h,d)}s[0].innerHTML=m}var p="";null!==l.loadingImgHTML?p=l.loadingImgHTML:l.loadingImgPath&&(p='<span class="fs-loading"><img src="'+l.loadingImgPath+'" alt=""></span>');var f="";f=null!==l.resultMsgTmpl?l.resultMsgTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<p>","{{#keywords}}「{{keywords}}」が {{/keywords}}","{{#count}}{{count}} 件見つかりました。{{/count}}","{{^count}}見つかりませんでした。{{/count}}","{{#count}}（{{lastPage}} ページ中 {{currentPage}} ページ目を表示）{{/count}}","</p>","</div>"].join("");var g="";g=null!==l.resultItemTmpl?l.resultItemTmpl:['<div id="'+l.resultBlockId+'-items">',"<ul>","{{#items}}","<li>{{&title}}</li>","{{/items}}","</ul>","</div>"].join("");var v="";v=null!==l.paginateTmpl?l.paginateTmpl:['<div{{#id}} id="{{id}}"{{/id}}{{#classname}} class="{{classname}}"{{/classname}}>',"<ul>","{{#showTurnPage}}","{{#exceptFirst}}",'<li class="fs-prev"><span><a class="fs-prev-link fs-turn-page-link" href="#" title="{{prevPageText}}">{{prevPageText}}</a></span></li>',"{{/exceptFirst}}","{{/showTurnPage}}","{{#page}}","{{#checkRange}}",'<li class="{{current}}"{{#hidePageNumber}} style="display:none;"{{/hidePageNumber}}><span><a class="fs-page-link {{currentLink}}" href="#" title="{{pageNumber}}">{{pageNumber}}</a></span></li>',"{{/checkRange}}","{{/page}}","{{#showTurnPage}}","{{#exceptLast}}",'<li class="fs-next"><span><a class="fs-next-link fs-turn-page-link" href="#" title="{{nextPageText}}">{{nextPageText}}</a></span></li>',"{{/exceptLast}}","{{/showTurnPage}}","</ul>","</div>"].join(""),s.find("form").on("submit",function(a){a.preventDefault();for(var t=e(this).attr("action")||location.href.replace(/\?.*/,""),n=e(this).serializeArray(),r=-1,s=n.length;++r<s;)"search"===n[r].name&&(n[r].value=e.trim(n[r].value.replace("　"," ")));n=l.submitAction(n);var i=e.param(n);return i&&(t=t+"?"+i),location.href=t,!1});var b=decodeURIComponent(location.search.replace(/^\?/,""));if(""===b){switch(typeof l.searchDataPathPreload){case"string":e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload});break;case"object":if(null===l.searchDataPathPreload||""===l.searchDataPathPreload)break;if(l.searchDataPathPreload.length)for(var y=-1,T=l.searchDataPathPreload.length;++y<T;)e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload[y]});else for(var P in l.searchDataPathPreload)e.ajax({type:"GET",cache:!0,dataType:"json",url:l.searchDataPathPreload[P]})}return!1}p&&(document.getElementById(l.resultBlockId).innerHTML=p);var x=[],M=b.split(/&|%26/),k={},I=[],j={},N=0,L=10,w="",C="",F="",R="",D="",H=!1,A=["search","dataId","offset","limit","sortBy","sortOrder","sortType"];null!==l.excludeParams&&e.merge(A,l.excludeParams.toLowerCase().split(","));for(var y=-1,T=M.length;++y<T;){var S=M[y].split("="),P=S[0],O=S[1]||"";switch(k[P]=O,P){case"search":O="+"===O?"":O,x=O.split(/\+| |%20/);break;case"offset":N=O;break;case"limit":L=O,null!==l.limit&&"number"==typeof l.limit&&(L=l.limit);break;case"dataId":D=O;break;case"sortBy":w=O.toLowerCase();break;case"sortOrder":C=O.toLowerCase();break;case"sortType":F=O.toLowerCase()}if("offset"!==P&&"limit"!==P){if(s.find("[name='"+P+"']").each(function(){var a=this.tagName.toLowerCase();switch(a){case"input":var t=e(this).attr("type");"checkbox"===t&&e(this).val()===O?e(this).prop("checked",!0):"radio"===t&&e(this).val()===O?e(this).prop("checked",!0):("text"===t||"search"===t||"hidden"===t)&&e(this).val("search"===P?O.replace("+"," "):O);break;case"select":e(this).find("option").each(function(){e(this).val()===O?e(this).prop("selected",!0):""===O&&" "===e(this).val()&&e(this).prop("selected",!0)})}}),""!==O){if(O=O.replace(/\+/g," "),-1!==e.inArray(P,A))continue;-1!==e.inArray(P,I)?j[P]+=","+O:j[P]=O}I.push(P)}}var B=0;for(var P in j)B++;switch(typeof l.searchDataPath){case"string":R=l.searchDataPath;break;case"object":if(""===D)return void window.alert("dataId is required.");null!==l.dataApiDataIds&&-1!==e.inArray(D,l.dataApiDataIds.split(","))&&(H=!0,null!==l.dataApiParams&&(b+=""!==b?"&"+e.param(l.dataApiParams):e.param(l.dataApiParams))),R=l.searchDataPath[D]}H&&(R+="?"+b),e.ajax({type:"GET",cache:l.cache,dataType:"json",url:R,error:function(e,a,t){l.ajaxError(e,a,t)},success:function(a){var s={};if(H)s=a;else{var i=e.grep(a.items,function(){return!0});i=e.grep(i,function(e,a){return t(e,j,B,"like",l.advancedSearchCond)}),i=e.grep(i,function(e,a){return n(e,x)}),null!==l.customSearch&&"function"==typeof l.customSearch&&(i=e.grep(i,function(e,a){return l.customSearch(e,k)}));var c=Number(L)+Number(N);s.totalResults=i.length,0!==s.totalResults&&""!==w&&w in i[0]&&("ascend"!==C&&(C="descend"),"numeric"!==F&&(F="string"),r(i,w,C,F)),s.items=e.grep(i,function(e,a){return N>a?!1:a>=c?!1:!0})}var o,u,d=Math.ceil(N/L)+1,m=Math.ceil(s.totalResults/L),h=l.maxPageCount?l.maxPageCount:100,p=h%2==0?h/2-1:Math.floor(h/2),b=h%2==0?h/2:Math.floor(h/2);h>=m?(o=1,u=m):(o=d-p,u=d+b,1>o?(o=1,u=h):u>m&&(b=m-d,u=m,p=h-b,o=d-p));for(var y=[],T=0,P=m;++T<=P;)y.push({pageNumber:T});var M={id:l.paginateId,classname:l.paginateClassName,page:y,hidePageNumber:l.hidePageNumber,showTurnPage:l.showTurnPage,prevPageText:l.prevPageText,nextPageText:l.nextPageText,isFirst:function(){return 1===d},isLast:function(){return y.length?d===y.length:!0},exceptFirst:function(){return 1!==d},exceptLast:function(){return y.length>0&&d!==y.length},checkRange:function(){return this.pageNumber>=o&&this.pageNumber<=u},current:function(){return this.pageNumber===d?"fs-current":this.pageNumber===d-1?"fs-current-prev":this.pageNumber===d+1?"fs-current-next":""},currentLink:function(){return this.pageNumber===d?"fs-current-link":this.pageNumber===d-1?"fs-current-prev-link":this.pageNumber===d+1?"fs-current-next-link":""}},I=Mustache.render(v,M),R={id:l.resultMsgId?l.resultMsgId:"",classname:l.resultMsgClassName?l.resultMsgClassName:"",keywords:x.join(", "),keywordArray:x,count:s.totalResults,metaTitle:document.title,firstPage:function(){return M.page[0].pageNumber},lastPage:function(){return M.page.length},currentPage:d},D=Mustache.render(f,R),A=l.resultMetaTitleTmpl?l.resultMetaTitleTmpl:["{{#keywordArray}}{{.}} {{/keywordArray}}","{{#count}} {{count}}件{{/count}}","{{#count}} {{currentPage}}/{{lastPage}}{{/count}}","{{#metaTitle}} | {{metaTitle}}{{/metaTitle}}"].join(""),S=Mustache.render(A,R);document.title=S,null!==l.modifyResultJSON&&"function"==typeof l.modifyResultJSON&&(s=l.modifyResultJSON(s));var O=Mustache.render(g,s);null!==l.modifyResultMsgHTML&&"function"==typeof l.modifyResultMsgHTML&&(D=l.modifyResultMsgHTML(D)),null!==l.modifyResultItemHTML&&"function"==typeof l.modifyResultItemHTML&&(O=l.modifyResultItemHTML(O)),null!==l.modifyPaginateHTML&&"function"==typeof l.modifyPaginateHTML&&(I=l.modifyPaginateHTML(I));var E="";if(null===l.resultMsgInsertMethods&&(E+=D),E+=O,null===l.paginateInsertMethods&&(E+=I),document.getElementById(l.resultBlockId).innerHTML=E,null!==l.resultMsgInsertMethods)for(var T=0,z=l.resultMsgInsertMethods.length;z>T;T++)e(l.resultMsgInsertMethods[T].selector)[l.resultMsgInsertMethods[T].method](D);if(null!==l.paginateInsertMethods)for(var T=0,z=l.paginateInsertMethods.length;z>T;T++)e(l.paginateInsertMethods[T].selector)[l.paginateInsertMethods[T].method](I);null!==l.resultComplete&&"function"==typeof l.resultComplete&&l.resultComplete(s.totalResults);var G=l.paginateId?"#"+l.paginateId:"."+l.paginateClassName;e(G).on("click","a.fs-page-link",function(a){a.preventDefault();var t=e(this).attr("title"),n=(Number(t)-1)*Number(L);n="offset="+n;var r=location.href.split("?"),l=r[1].replace(/offset=[0-9]+/,n);location.href=r[0]+"?"+l}).on("click","a.fs-turn-page-link",function(a){a.preventDefault(),e(this).hasClass("fs-prev-link")?e(a.delegateTarget).find(".fs-current-prev-link").trigger("click"):e(this).hasClass("fs-next-link")&&e(a.delegateTarget).find(".fs-current-next-link").trigger("click")})}})},e.fn.flexibleSearch.defaults={limit:null,searchDataPath:"/flexibleSearch/search.json",searchDataPathPreload:null,dataApiDataIds:null,dataApiParams:null,cache:!0,searchFormCreation:!0,searchFormHTML:null,searchFormAction:"",searchFormInputType:"search",searchFormInputPlaceholder:"Search words",searchFormSubmitBtnText:"Search",advancedFormObj:null,advancedSearchCond:"OR",loadingImgPath:"/flexibleSearch/loading.gif",loadingImgHTML:null,resultBlockId:"fs-result",resultItemTmpl:null,resultMsgId:null,resultMsgClassName:"fs-result-msg",resultMsgTmpl:null,resultMetaTitleTmpl:null,resultMsgInsertMethods:null,paginateId:null,paginateClassName:"fs-paginate",paginateTmpl:null,paginateCount:10,hidePageNumber:!1,showTurnPage:!0,prevPageText:"Prev",nextPageText:"Next",maxPageCount:10,paginateInsertMethods:null,submitAction:function(e){return e},ajaxError:function(e,a,t){window.alert(a)},customSearch:null,modifyResultJSON:null,modifyResultMsgHTML:null,modifyResultItemHTML:null,modifyPaginateHTML:null,resultComplete:null,excludeParams:null,dummy:!1}}(jQuery);
